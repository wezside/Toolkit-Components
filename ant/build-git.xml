<?xml version="1.0" encoding="UTF-8"?>
<project name="Toolkit Component Build Git" default="push-remote" basedir="..">

	<property file="ant/.git-properties" />
	<property file="ant/.toolkit-properties" />

	<condition property="isLinux">
	  <os family="unix" />
	</condition>
	
	<condition property="isWin">
	    <os family="windows" />		
	</condition>	
	
	<target name="linux" if="isLinux">
	    <echo message="OS is Linux" />
		<property name="GIT_HOME" value="${GIT_HOME_LINUX}"/>
		<property name="git.config" value="${git.config.linux}"/>
	</target>
	
	<target name="win" if="isWin">
	    <echo message="OS is Windows" />
		<property name="GIT_HOME" value="${GIT_HOME_PC}"/>
		<property name="git.config" value="${git.config.pc}"/>
	</target>		
	
	<macrodef name="git">
		<attribute name="command" />
		<attribute name="dir" default="" />
		<element name="args" optional="true" />
		<sequential>
			<echo message="git @{command} " />
			<exec executable="${GIT_HOME}git" dir="@{dir}">
				<env key="HOME" value="${git.config}"/>
				<arg value="@{command}" />
				<args />
			</exec>
		</sequential>
	</macrodef>

	<macrodef name="git-push-to-branch">
		<attribute name="branch" />
		<attribute name="remoteRepositoryName" />
		<sequential>
			<git command="push" dir="${basedir}">
				<args>
					<arg value="@{remoteRepositoryName}" />
					<arg value="@{branch}" />
					<arg value="--tags" />
				</args>
			</git>
		</sequential>
	</macrodef>

	<target name="commit" depends="win,linux">
		
		<condition property="tag.release">
			<matches pattern="([0-9][0-9][0-9]0)" string="${build.int}" />
		</condition>

		<propertyfile file="${prop.file}" comment="Update build version">
			<entry key="build.int" type="int" default="0001" operation="+" pattern="0000" />
		</propertyfile>		
		
		<echo message="[Auto Build] Commit ${project.name} Release ${version}${build.int}" />

		<git command="add" dir="${basedir}">
			<args>
				<arg value="." />
			</args>
		</git>

		<git command="commit" dir="${basedir}">
			<args>
				<arg value="." />
				<arg value="-m" />
				<arg value="[Auto Build] ${project.name} ${version}${build.int}" />
			</args>
		</git>
	</target>

	<target name="tag" if="tag.release" depends="commit">
		<echo message="[Auto Build ] Tag ${project.name} Release ${version}${build.int}] " />
		<git command="tag" dir="${basedir}">
			<args>
				<arg value="${version}${build.int}" />
				<arg value="-m" />
				<arg value="[Auto Tag ${project.name} Release ${version}${build.int}]" />
			</args>
		</git>
	</target>

	<target name="push-remote" depends="tag">
		<echo message="Pushing to remote repository" />
		<git-push-to-branch branch="master" remoteRepositoryName="origin" />
	</target>
</project>
